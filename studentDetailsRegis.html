<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

    <title>Contact</title>
    <meta content="" name="description" />
    <meta content="" name="keywords" />

    <!-- Favicons -->
    <link href="assets/img/favicon.png" rel="icon" />
    <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Roboto:300,300i,400,400i,500,500i,700,700i&display=swap"
      rel="stylesheet" />

    <!-- Vendor CSS Files -->
    <link href="assets/vendor/animate.css/animate.min.css" rel="stylesheet" />
    <link href="assets/vendor/aos/aos.css" rel="stylesheet" />
    <link
      href="assets/vendor/bootstrap/css/bootstrap.min.css"
      rel="stylesheet" />
    <link
      href="assets/vendor/bootstrap-icons/bootstrap-icons.css"
      rel="stylesheet" />

    <!-- bootstrap -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous" />

    <!--  Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
    <link rel="stylesheet" href="assets/css/font.css" />
  </head>

  <body>
    <!-- bootstrap min js -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"></script>

    <script src="assets/js/utils.js"></script>

    <main class="main-content-layout">
      <div class="content-wrapper shadow bg-light">
        <!-- ======= Header ======= -->
        <div class="content-header shadow-lg">
          <div class="dropdown">
            <span
              class="p-2 rounded-3 text-bg-info dropdown-toggle"
              role="button"
              id="dropdownMenuLink"
              data-bs-toggle="dropdown"
              ><i class="bi bi-list"></i>
            </span>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" href="#" id="editProfileBtn">
                  <i class="bi bi-pencil-square"></i> Edit Profile</a
                >
              </li>
              <li>
                <a class="dropdown-item" id="logout">
                  <i class="bi bi-box-arrow-left"></i> Logout</a
                >
              </li>
            </ul>
          </div>
          <span class="text-light fs-2"
            ><span id="userNameEl">Student Name</span></span
          >
        </div>
        <!-- End Header -->

        <div
          class="border border-3 border border-2 p-4 m-4 d-flex flex-column overflow-auto">
          <form class="row g-3 needs-validation" novalidate>
            <div class="col-lg-12 d-flex justify-content-center">
              <img
                src="assets/img/noimg.avif"
                alt="profile_img"
                class="profile-img shadow"
                id="user_image" />
            </div>
            <div class="col-lg-12 d-flex justify-content-center">
              <button
                type="button"
                class="btn btn-danger"
                onclick="onClickChangePicture(event)">
                Change picture
              </button>
              <input
                type="file"
                name="user_image"
                id="imgfileInput"
                style="display: none" />
            </div>
            <div class="col-lg-6">
              <label for="studentNameInput" class="form-label"
                >Student Name</label
              >
              <input
                class="form-control"
                id="studentNameInput"
                name="user_name"
                required />
              <div class="invalid-feedback">Please enter your name.</div>
            </div>
            <div class="col-lg-6">
              <label for="departNameInput" class="form-label">Department</label>
              <input
                class="form-control"
                id="departNameInput"
                name="department"
                required />
              <div class="invalid-feedback">
                Please enter a department name.
              </div>
            </div>

            <div class="col-lg-6">
              <label for="dOBInput" class="form-label">Date of birth</label>
              <input
                class="form-control"
                id="dOBInput"
                name="dob"
                type="date"
                required />
              <!-- min="2000-01-01"
                          max="2023-12-31" -->
              <div class="invalid-feedback">
                Please enter your date of birth.
              </div>
            </div>
            <div class="col-lg-6">
              <label for="yearOfJoiningInput" class="form-label"
                >Year of joining</label
              >
              <input
                class="form-control"
                id="yearOfJoiningInput"
                name="year_join"
                type="number"
                required />
              <!-- max="2020" -->
              <div class="invalid-feedback">
                Please enter your year of joining.
              </div>
            </div>
            <div class="col-lg-6">
              <label for="yearOfPassingInput" class="form-label"
                >Year of passing</label
              >
              <input
                class="form-control"
                id="yearOfPassingInput"
                type="number"
                name="year_pass"
                required />
              <!-- max="2023" -->
              <div class="invalid-feedback">
                Please enter your year of passing.
              </div>
            </div>
            <div class="col-lg-6">
              <label for="admissionNoInput" class="form-label"
                >Admission no.</label
              >
              <input
                class="form-control"
                name="admission_no"
                id="admissionNoInput"
                required />
              <div class="invalid-feedback">
                Please enter your admission number.
              </div>
            </div>
            <div class="col-lg-6">
              <label for="aadharInput" class="form-label">Aadhar Number</label>
              <input
                class="form-control"
                name="aadhar_card"
                id="aadharInput"
                required />
              <div class="invalid-feedback">
                Please enter your aadhar number.
              </div>
            </div>
            <div class="col-lg-6">
              <label for="mobileNoInput" class="form-label"
                >Mobile Number</label
              >
              <input
                class="form-control"
                name="mobile_number"
                id="mobileNoInput"
                required />
              <div class="invalid-feedback">
                Please enter your Mobile number.
              </div>
            </div>
            <div class="col-lg-6">
              <label for="bloodGroupInput" class="form-label"
                >Blood Group</label
              >
              <input
                class="form-control"
                id="bloodGroupInput"
                name="blood_group"
                required />
              <div class="invalid-feedback">Please enter your blood group.</div>
            </div>
            <div class="col-12">
              <label class="form-label"
                >Do students come under any special category?</label
              >
              <div class="col-lg-6">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="special_category"
                    id="exServiveManDaughter"
                    value="Ex Service Man Daughter"
                    required />
                  <label class="form-check-label" for="exServiveManDaughter">
                    Ex Service Man Daughter
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="special_category"
                    id="sportsQuota"
                    value="Sports Quota"
                    required />
                  <label class="form-check-label" for="sportsQuota">
                    Sports Quota
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="special_category"
                    id="physicallyChallenged"
                    value="Physically challenged"
                    required />
                  <label class="form-check-label" for="physicallyChallenged">
                    Physically challenged
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="special_category"
                    id="None"
                    value="None"
                    required />
                  <label class="form-check-label" for="None"> None </label>
                </div>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label"
                >Do students receive any scholarships from below?</label
              >
              <div class="col-lg-6">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="scholarship"
                    id="minority"
                    value="Minority"
                    required />
                  <label class="form-check-label" for="minority">
                    Minority
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="scholarship"
                    id="uzhavar"
                    value="Uzhavar"
                    required />
                  <label class="form-check-label" for="uzhavar">
                    Uzhavar
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="scholarship"
                    id="moovalur"
                    value="Moovalur"
                    required />
                  <label class="form-check-label" for="moovalur">
                    Moovalur
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="scholarship"
                    id="beediScholarship"
                    value="Beedi scholarship"
                    required />
                  <label class="form-check-label" for="beediScholarship">
                    Beedi scholarship
                  </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="scholarship"
                    id="None"
                    value="None"
                    required />
                  <label class="form-check-label" for="None"> None </label>
                </div>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label"
                >Are you the first person in your family to graduate from
                college?</label
              >
              <div class="col-lg-6">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="first_graduate"
                    id="fgYes"
                    value="true"
                    required />
                  <label class="form-check-label" for="fgYes"> Yes </label>
                </div>
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="first_graduate"
                    id="fgNo"
                    value="false"
                    required />
                  <label class="form-check-label" for="fgNo"> No </label>
                </div>
              </div>
            </div>

            <!-- address details -->
            <label class="form-label">Address Details:</label>
            <div class="col-lg-6">
              <label for="addressLine1Input" class="form-label"
                >Address Line1</label
              >
              <input
                class="form-control"
                name="address_line1"
                id="addressLine1Input"
                required />
              <div class="invalid-feedback">
                Please enter your streetno/village/block.
              </div>
            </div>
            <div class="col-lg-6">
              <label for="addressLine2Input" class="form-label"
                >Address Line2</label
              >
              <input
                class="form-control"
                name="address_line2"
                id="addressLine2Input"
                required />
              <div class="invalid-feedback">
                Please enter your locality/panchayat/municipal.
              </div>
            </div>
            <div class="col-lg-6">
              <label for="districtInput" class="form-label">District</label>
              <input
                class="form-control"
                id="districtInput"
                name="city"
                required />
              <div class="invalid-feedback">Please enter your district.</div>
            </div>
            <div class="col-lg-6">
              <label for="stateInput" class="form-label">State</label>
              <input
                class="form-control"
                id="stateInput"
                name="state"
                required />
              <div class="invalid-feedback">Please enter your state.</div>
            </div>
            <div class="col-lg-12">
              <div class="col-lg-6">
                <label for="pincodeInput" class="form-label">Pincode</label>
                <input
                  class="form-control"
                  id="pincodeInput"
                  pattern="[0-9]{6}"
                  name="pincode"
                  required />
                <div class="invalid-feedback">
                  Please enter your valid 6-digit zipcode/pincode.
                </div>
              </div>
            </div>

            <!-- extra course details -->
            <div class="col-lg-6">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="isExtraCourseInput"
                  name="extra_course" />
                <label class="form-check-label" for="isExtraCourseInput">
                  Have you attending any extra courses?
                </label>
              </div>
            </div>
            <div class="col-lg-8" id="extra-course-container">
              <label class="form-label" for="extraCourseDetailInput"
                >Extra Course Details:</label
              >
              <textarea
                class="form-control"
                id="extraCourseDetailInput"
                placeholder="Enter here"
                rows="4"
                required
                name="extra_course_details"></textarea>
              <div class="invalid-feedback">
                Please enter a details about your extra courses.
              </div>
            </div>

            <!-- Internship Detail -->
            <div class="col-lg-8">
              <label class="form-label" for="intershipInput"
                >Internship Details:</label
              >
              <textarea
                class="form-control"
                id="intershipInput"
                placeholder="Enter here"
                name="internship"
                rows="4"
                required></textarea>
              <div class="invalid-feedback">
                Please enter a details about your Internship.
              </div>
            </div>

            <!-- Student Mark Percentage -->
            <label class="form-label">Student Mark Percentage:</label>
            <div class="row col-lg-12">
              <div class="col-lg-2">
                <label for="sem1Input" class="form-label">SEM 1</label>
                <input
                  class="form-control"
                  id="sem1Input"
                  name="sem1"
                  pattern="[0-9]{2,3}"
                  required />
              </div>
              <div class="col-lg-2">
                <label for="sem2Input" class="form-label">SEM 2</label>
                <input
                  class="form-control"
                  name="sem2"
                  id="sem2Input"
                  pattern="[0-9]{2,3}"
                  required />
              </div>
              <div class="col-lg-2">
                <label for="sem3Input" class="form-label">SEM 3</label>
                <input
                  class="form-control"
                  id="sem3Input"
                  name="sem3"
                  pattern="[0-9]{2,3}"
                  required />
              </div>
              <div class="col-lg-2">
                <label for="sem4Input" class="form-label">SEM 4</label>
                <input
                  class="form-control"
                  id="sem4Input"
                  name="sem4"
                  pattern="[0-9]{2,3}"
                  required />
              </div>
              <div class="col-lg-2">
                <label for="sem5Input" class="form-label">SEM 5</label>
                <input
                  class="form-control"
                  id="sem5Input"
                  name="sem5"
                  pattern="[0-9]{2,3}"
                  required />
              </div>
              <div class="col-lg-2">
                <label for="sem6Input" class="form-label">SEM 6</label>
                <input
                  class="form-control"
                  id="sem6Input"
                  pattern="[0-9]{2,3}"
                  name="sem6"
                  required />
              </div>
            </div>
            <div class="col-lg-6">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="isHigherEducationInput"
                  name="higher_education" />
                <label class="form-check-label" for="isHigherEducationInput">
                  Have you registered for any higher education?
                </label>
              </div>
            </div>
            <div class="col-lg-8" id="higher-education-container">
              <label class="form-label" for="higherEducationDetailInput"
                >Higher Education Details:</label
              >
              <textarea
                class="form-control"
                id="higherEducationDetailInput"
                placeholder="Enter here"
                name="higher_education_details"
                rows="2"
                required></textarea>
              <div class="invalid-feedback">
                Please enter a details about your higher education.
              </div>
            </div>

            <div class="col-lg-8">
              <label class="form-label" for="employementInput"
                >Employement Details:</label
              >
              <textarea
                class="form-control"
                id="employementInput"
                name="employment_details"
                placeholder="Enter here"
                rows="2"
                required></textarea>
              <div class="invalid-feedback">
                Please enter a details about your employement details.
              </div>
            </div>

            <div class="col-12">
              <button
                class="btn btn-secondary"
                type="button"
                data-bs-toggle="modal"
                data-bs-target="#cancel">
                Cancel
              </button>
              <button class="btn btn-primary" type="submit">
                Update Details
              </button>
            </div>
          </form>
          <!-- Modal -->
          <div
            class="modal fade"
            id="cancel"
            tabindex="-1"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">
                    Any changes made will be lost. Are you sure you want to
                    cancel?
                  </h5>
                  <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                    aria-label="Close"></button>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal">
                    cancel
                  </button>
                  <button
                    type="button"
                    class="btn btn-primary"
                    data-bs-dismiss="modal"
                    onclick="onClickConfirmCancelBtn(event)">
                    confirm
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
    <!-- End #main -->

    <script>
      //gloval var
      const getJWtToken = localStorage.getItem("jwttoken");
      const getUserId = localStorage.getItem("userId");
      const formDataImage = new FormData();

      // edit profile toggler
      document
        .getElementById("editProfileBtn")
        .addEventListener("click", (e) => {
          e.preventDefault();
          disableFormInputs(false);
        });

      // onclick logout
      document.getElementById("logout").addEventListener("click", (e) => {
        e.preventDefault();
        localStorage.clear();
        alert("user loggedout successfully!");
        window.location.href = "index.html";
      });

      // disable all form inputs
      const disableFormInputs = (disableVal = true) => {
        var inputs = document.querySelectorAll(
          "form input, form select, form textarea, form button"
        );
        inputs.forEach(function (input) {
          input.disabled = disableVal;
        });
      };
      disableFormInputs(true);

      // set initial values to the form inputs
      const setInitialFormValue = (initialFormValues) => {
        document.getElementById("userNameEl").innerText =
          initialFormValues.user_name;

        document.getElementById("user_image").src =
          initialFormValues.user_image == "None" ||
          !initialFormValues.user_image
            ? "assets/img/noimg.avif"
            : initialFormValues.user_image;

        let inputs = document.querySelectorAll(
          "form input, form select, form textarea"
        );
        inputs.forEach(function (input) {
          if (input.name.startsWith("sem")) {
            input.value = initialFormValues.sem_detail.length
              ? initialFormValues.sem_detail.find(
                  (itm) => itm.sem == input.name[input.name.length - 1]
                ).percentage
              : "";
          } else if (input.type == "radio") {
            if (input.value == initialFormValues[input.name].toString()) {
              input.checked = true;
            }
          } else if (input.type == "date") {
            input.value = new Date(initialFormValues[input.name])
              .toISOString()
              .split("T")[0];
          } else if (input.type == "file") {
            return;
          } else {
            input.value = initialFormValues[input.name];
          }
        });
        let checkboxes = document.querySelectorAll(
          "input[type=checkbox][value=true]"
        );
        Array.from(checkboxes).map((checkbox) => {
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event("change"));
        });
      };

      // fetch the user details
      const fetchUserData = async () => {
        if (getJWtToken && getUserId) {
          const getUserRes = await fetch(
            "http://localhost:5000/api/admin/getByIdPerson/" + getUserId,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          if (!getUserRes.ok) {
            return alert("Failed to fetch user details");
          }
          const response = await getUserRes.json();
          if (response.code == 200 && response.data.length) {
            const initialFormData = response.data[0];
            setInitialFormValue(initialFormData);
          } else {
            return alert("Failed to fetch user details");
          }
        }
      };
      fetchUserData();

      // update the user details
      const updateUserDetails = async (formValues) => {
        const { sem1, sem2, sem3, sem4, sem5, sem6, ...rest } = formValues;
        let updatedData = {
          ...rest,
          sem_detail: [
            {
              sem: 1,
              percentage: sem1,
            },
            {
              sem: 2,
              percentage: sem2,
            },
            {
              sem: 3,
              percentage: sem3,
            },
            {
              sem: 4,
              percentage: sem4,
            },
            {
              sem: 5,
              percentage: sem5,
            },
            {
              sem: 6,
              percentage: sem6,
            },
          ],
        };

        if (formDataImage.entries().next().value) {
          const updateImage = await fetch(
            "http://localhost:5000/api/admin/upload",
            {
              method: "POST",

              body: formDataImage,
            }
          );
          if (!updateImage.ok) {
            return alert("Failed to update the image");
          }
          const response = await updateImage.json();
          if (response.code == 201) {
            updatedData = { ...updatedData, user_image: response.image_url };
          }
        }

        const updateUser = await fetch(
          "http://localhost:5000/api/admin/updatePerson/" + getUserId,
          {
            method: "PATCH",
            headers: {
              "Content-Type": "application/json",
              authorization: `Bearer ${getJWtToken}`,
            },
            body: JSON.stringify(updatedData),
          }
        );
        if (!updateUser.ok) {
          return alert("Failed: Something went wrong");
        }
        const response = await updateUser.json();

        if (response.code == 200) {
          alert("User updated succesfully!");
          fetchUserData();
          disableFormInputs(true);
        } else {
          alert(response.message);
        }
      };

      // click cancel button event
      const onClickConfirmCancelBtn = (e) => {
        e.preventDefault();
        location.reload();
      };

      // click cancel button event
      const onClickChangePicture = (e) => {
        e.preventDefault();
        e.stopPropagation();
        document.getElementById("imgfileInput").click();
      };

      document
        .getElementById("imgfileInput")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const img = document.getElementById("user_image");
              img.src = e.target.result;
            };
            reader.readAsDataURL(file);
          }
          formDataImage.append("fileName", file);
        });

      // handling the initial form views
      const formHandling = () => {
        let form = document.querySelector(".needs-validation");
        let extraCourseInput = document.getElementById("isExtraCourseInput");
        let isHigherEdu = document.getElementById("isHigherEducationInput");

        document.getElementById("extra-course-container").style.display =
          "none";
        document.getElementById("higher-education-container").style.display =
          "none";

        extraCourseInput.addEventListener("change", (event) => {
          if (event.target.checked) {
            document.getElementById("extra-course-container").style.display =
              "initial";
          } else {
            document.getElementById("extra-course-container").style.display =
              "none";
          }
        });

        isHigherEdu.addEventListener("change", (event) => {
          if (event.target.checked) {
            document.getElementById(
              "higher-education-container"
            ).style.display = "initial";
          } else {
            document.getElementById(
              "higher-education-container"
            ).style.display = "none";
          }
        });

        // click Update details button event
        form.addEventListener(
          "submit",
          function (event) {
            event.preventDefault();
            event.stopPropagation();
            if (!form.checkValidity()) {
              form.classList.add("was-validated");
              return;
            }
            // Get form values
            const formData = new FormData(this); // 'this' refers to the form element

            // Convert formData to object
            const formValues = {};
            formData.forEach(function (value, key) {
              formValues[key] = value;
            });
            // api call form submission
            updateUserDetails(formValues);
          },
          false
        );
      };
      formHandling();
      // window.addEventListener("beforeunload", function (e) {
      //   e.preventDefault();
      // });
    </script>
  </body>
</html>
